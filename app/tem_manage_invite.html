<!doctype html>
<html lang="">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="black" name="apple-mobile-web-app-status-bar-style">
  <meta name="format-detection" content="telephone=no">
  <title>demo</title>
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="public/styles/main.css">
  <!-- endbuild -->
  <style>

  </style>
</head>
<body>
<div class="wei-container3">
  <header class="wei-head clearfix">
    <a href="javascript:;" class="wei-arr-container"><span class="wei-arrow-left"></span></a>
    <span>我的邀请</span>
  </header>
  <section class="invite">
    <div id="wrapper">
      <div id="scroller">
        <div class="head">
          <div>总共邀请12人</div>
          <div>累计获得<span class="num">3600</span>福分</div>
        </div>
        <ul class="list" id="d_list">
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
          <li>
            <div class="items-a">
              <div class="photo-container">
                <img src="public/img/light5.jpg">
              </div>
            </div>
            <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
            <div class="items-c">13838384381</div>
            <div class="items-d">2017-01-01</div>
          </li>
        </ul>
      </div>
    </div>
  </section>
</div>
<!-- build:js scripts/main.js -->
<script src="public/scripts/jquery-3.0.0.js"></script>
<script src="public/scripts/iscroll-probe.js"></script>
<script src="public/scripts/layer.js"></script>
<!-- endbuild -->
<script type="text/javascript">
  var wrapper = document.getElementById('wrapper'),
    scroller = document.getElementById('scroller'),
    d_list = document.getElementById('d_list'),
    pullUpEl, pullDownEl,
    pullDownOffset, pullUpOffset,
    page = 0, flag = false;

  function ajax (url, parms) {
    parms = parms || {};
    var req = new XMLHttpRequest(),
      post = parms.post || null,
      callback = parms.callback || null,
      timeout = parms.timeout || null;

    req.onreadystatechange = function () {
      if ( req.readyState != 4 ) return;

      // Error
      if ( req.status != 200 && req.status != 304 ) {
        if ( callback ) callback(false);
        return;
      }

      if ( callback ) callback(req.responseText);
    };

    if ( post ) {
      req.open('POST', url, true);
      req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    } else {
      req.open('GET', url, true);
    }

    req.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

    req.send(post);

    if ( timeout ) {
      setTimeout(function () {
        req.onreadystatechange = function () {};
        req.abort();
        if ( callback ) callback(false);
      }, timeout);
    }
  }
  var myScroll;
  function loaded () {
    pullUpEl = document.createElement("div");
    pullUpEl.id = 'pullUp';
    pullUpEl.innerHTML = '<span class="pullUpIcon"></span><span class="pullUpLabel">上拉加载更多...</span>';
    scroller.insertBefore(pullUpEl, null);

/*    pullDownEl = document.createElement("div");
    pullDownEl.id = 'pullDown';
    pullDownEl.innerHTML = '<span class="pullDownIcon"></span><span class="pullDownLabel">下拉刷新...</span>';
    scroller.insertBefore(pullDownEl, scroller.childNodes[0]);*/

    pullUpOffset = pullUpEl.offsetHeight;
//    pullDownOffset = pullDownEl.offsetHeight;

    myScroll = new IScroll('#wrapper', {
      mouseWheel: true,
      probeType: 3,
    });
    myScroll.on('scroll', scrollMove);
    myScroll.on('scrollEnd', scrollEnd);
    myScroll.on('scrollStart', scrollStart);


  }

  function scrollStart() {
//    pullDownEl.style.visibility = 'visible';
//    pullUpEl.style.visibility = 'visible';
  }

  function scrollMove() {
/*    console.log(this.minScrollY);
    if (this.y > 10 && !pullDownEl.className.match('flip')) {
      pullDownEl.className = 'flip';
      pullDownEl.querySelector('.pullDownLabel').innerHTML = '松手开始更新...';
    } else if (this.y < 10 && pullDownEl.className.match('flip')) {
      pullDownEl.className = '';
      pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
    } else */
      if (this.y < (this.maxScrollY - 10) && this.maxScrollY < 1 && !pullUpEl.className.match('flip')) {
      pullUpEl.className = 'flip';
      pullUpEl.querySelector('.pullUpLabel').innerHTML = '松手开始更新...';
    } else if (this.y > (this.maxScrollY + 10) && pullUpEl.className.match('flip')) {
      pullUpEl.className = '';
      pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
    }
  }

  function scrollEnd() {
/*    if (pullDownEl.className.match('flip')) {
      pullDownEl.className = 'loading';
      pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
      pullDownAction();
    } else */
      if (pullUpEl.className.match('flip')) {
      pullUpEl.className = 'loading';
      pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
      pullUpAction();
    }


  }

  function pullUpAction () {
    requestData(d_list, page);
  }

/*  function pullDownAction () {
    console.log('down');
  }*/

  function requestData (start, page) {
    ajax('public/scripts/json/data.json?&page=' + page, {
      post: false,
      callback: function (data) {
        /*
        *
        *   <li>
               <div class="items-a">
                 <div class="photo-container">
                    <img src="public/img/light5.jpg">
                 </div>
               </div>
               <div class="items-b overText">啊啊aaaaaaaaaaaaaaaaa啊啊啊啊</div>
               <div class="items-c">13838384381</div>
               <div class="items-d">2017-01-01</div>
             </li>
        *
        * */
        data = JSON.parse(data);
        var _data = [];
        if(data.success != 1){
          layer.open({
            content: data.message
            ,skin: 'msg'
            ,time: 2
          });
        }else {
          if(data.response.page.current_page !== data.response.page.next_page){
            flag = true;
            if(flag){

            }
            page = data.response.page.next_page;
            _data = data.response.entries;
            updateContent(start, _data);
          }
        }


      }
    });
  }

  function updateContent (el, data) {
    for (var i in data)
    {
      var _li = document.createElement("li");
      _li.innerHTML = '<div class="items-a">' +
        '<div class="photo-container">' +
      '<img src="' +
        data[i].avatar +
        '">' +
      '</div>' +
      '</div>' +
      '<div class="items-b overText">' +
        data[i].nickname +
        '</div>' +
      '<div class="items-c">' +
        data[i].mobile +
        '</div>' +
      '<div class="items-d">' +
        data[i].create_time +
        '</div>';
      el.insertBefore(_li, null);
    }
    setTimeout(function () {
      myScroll.refresh();

      pullUpEl.className = '';
      pullUpEl.querySelector('.pullUpLabel').innerHTML = '上拉加载更多...';
    }, 1000);
  }

  document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
  function isPassive() {
    var supportsPassiveOption = false;
    try {
      addEventListener("test", null, Object.defineProperty({}, 'passive', {
        get: function () {
          supportsPassiveOption = true;
        }
      }));
    } catch(e) {}
    return supportsPassiveOption;
  }
  document.addEventListener('DOMContentLoaded', loaded, false);
</script>
</body>
</html>
